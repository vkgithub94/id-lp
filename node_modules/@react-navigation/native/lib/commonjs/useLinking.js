var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=useLinking;var React=_interopRequireWildcard(require("react"));var _core=require("@react-navigation/core");var getStateLength=function getStateLength(state){var length=0;if(state.history){length=state.history.length;}else{length=state.index+1;}var focusedState=state.routes[state.index].state;if(focusedState&&!focusedState.stale){length+=getStateLength(focusedState)-1;}return length;};var isUsingLinking=false;function useLinking(ref,_ref){var prefixes=_ref.prefixes,config=_ref.config,_ref$getStateFromPath=_ref.getStateFromPath,getStateFromPath=_ref$getStateFromPath===void 0?_core.getStateFromPath:_ref$getStateFromPath,_ref$getPathFromState=_ref.getPathFromState,getPathFromState=_ref$getPathFromState===void 0?_core.getPathFromState:_ref$getPathFromState;React.useEffect(function(){if(isUsingLinking){throw new Error("Looks like you are using 'useLinking' in multiple components. This is likely an error since URL integration should only be handled in one place to avoid conflicts.");}else{isUsingLinking=true;}return function(){isUsingLinking=false;};});var prefixesRef=React.useRef(prefixes);var configRef=React.useRef(config);var getStateFromPathRef=React.useRef(getStateFromPath);var getPathFromStateRef=React.useRef(getPathFromState);React.useEffect(function(){prefixesRef.current=prefixes;configRef.current=config;getStateFromPathRef.current=getStateFromPath;getPathFromStateRef.current=getPathFromState;},[config,getPathFromState,getStateFromPath,prefixes]);var getInitialState=React.useCallback(function(){var path=location.pathname+location.search;if(path){return getStateFromPathRef.current(path,configRef.current);}else{return undefined;}},[]);var previousStateLengthRef=React.useRef(undefined);var previousHistoryIndexRef=React.useRef(0);var pendingIndexChangeRef=React.useRef();var pendingStateUpdateRef=React.useRef(false);var pendingStateMultiUpdateRef=React.useRef(false);var numberOfIndicesAhead=React.useRef(0);React.useEffect(function(){window.addEventListener('popstate',function(){var _ref2,_history$state;var navigation=ref.current;if(!navigation){return;}var previousHistoryIndex=previousHistoryIndexRef.current;var historyIndex=(_ref2=(_history$state=history.state)==null?void 0:_history$state.index)!=null?_ref2:0;previousHistoryIndexRef.current=historyIndex;if(pendingIndexChangeRef.current===historyIndex){pendingIndexChangeRef.current=undefined;return;}var state=navigation.getRootState();var path=getPathFromStateRef.current(state,configRef.current);var canGoBack=true;var numberOfBacks=0;if(previousHistoryIndex===historyIndex){if(location.pathname+location.search!==path){pendingStateUpdateRef.current=true;history.replaceState({index:historyIndex},'',path);}}else if(previousHistoryIndex>historyIndex){numberOfBacks=previousHistoryIndex-historyIndex-numberOfIndicesAhead.current;if(numberOfBacks>0){pendingStateMultiUpdateRef.current=true;if(numberOfBacks>1){pendingStateMultiUpdateRef.current=true;}pendingStateUpdateRef.current=true;for(var i=0;i<numberOfBacks;i++){navigation.goBack();}}else{canGoBack=false;}}if(previousHistoryIndex<historyIndex||!canGoBack){if(canGoBack){numberOfIndicesAhead.current=historyIndex-previousHistoryIndex-1;}else{navigation.goBack();numberOfIndicesAhead.current-=previousHistoryIndex-historyIndex;}var _state=getStateFromPathRef.current(location.pathname+location.search,configRef.current);pendingStateMultiUpdateRef.current=true;if(_state){var action=(0,_core.getActionFromState)(_state);pendingStateUpdateRef.current=true;if(action.type==='RESET_ROOT'){navigation.resetRoot(action.payload);}else{navigation.dispatch(action);}}}});},[ref]);React.useEffect(function(){var _ref$current;if(ref.current&&previousStateLengthRef.current===undefined){previousStateLengthRef.current=getStateLength(ref.current.getRootState());}if(ref.current&&location.pathname+location.search==='/'){var _ref3,_history$state2;history.replaceState({index:(_ref3=(_history$state2=history.state)==null?void 0:_history$state2.index)!=null?_ref3:0},'',getPathFromStateRef.current(ref.current.getRootState(),configRef.current));}var unsubscribe=(_ref$current=ref.current)==null?void 0:_ref$current.addListener('state',function(){var _previousStateLengthR,_ref4,_history$state3;var navigation=ref.current;if(!navigation){return;}var state=navigation.getRootState();var path=getPathFromStateRef.current(state,configRef.current);var previousStateLength=(_previousStateLengthR=previousStateLengthRef.current)!=null?_previousStateLengthR:1;var stateLength=getStateLength(state);if(pendingStateMultiUpdateRef.current){if(location.pathname+location.search===path){pendingStateMultiUpdateRef.current=false;}else{return;}}previousStateLengthRef.current=stateLength;if(pendingStateUpdateRef.current&&location.pathname+location.search===path){pendingStateUpdateRef.current=false;return;}var index=(_ref4=(_history$state3=history.state)==null?void 0:_history$state3.index)!=null?_ref4:0;if(previousStateLength===stateLength){if(location.pathname+location.search!==path){history.replaceState({index:index},'',path);previousHistoryIndexRef.current=index;}}else if(stateLength>previousStateLength){for(var i=0,l=stateLength-previousStateLength;i<l;i++){index++;history.pushState({index:index},'',path);}previousHistoryIndexRef.current=index;}else if(previousStateLength>stateLength){var delta=previousStateLength-stateLength;pendingIndexChangeRef.current=index-delta;history.go(-delta);}});return unsubscribe;});return{getInitialState:getInitialState};}
//# sourceMappingURL=useLinking.js.map